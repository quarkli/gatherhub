<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>SVG Lab1</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
		<div id="whiteboard">
			<svg id="svgboard"><svg>
		</div>
		<div id="toolbar">
			<button onclick="setColor('black')">K</button>
			<button onclick="setColor('red')">R</button>
			<button onclick="setColor('green')">G</button>
			<button onclick="setColor('blue')">B</button>
			<button onclick="setColor('white')">W</button>
			<button onclick="setWidth(this.innerHTML)">1</button>
			<button onclick="setWidth(this.innerHTML)">5</button>
			<button onclick="setWidth(this.innerHTML)">9</button>
			<button onclick="setWidth(this.innerHTML)">21</button>
			<button onclick="setPin('rect')">方</button>
			<button onclick="setPin('round')">圆</button>
			<button onclick="undo()">Undo</button>
			<button onclick="redo()">Redo</button>
			<button onclick="reset()">Reset</button>
		</div>
    </body>
<script>
var enableLog = true; // Set 'true' to turn on log message;

var penColor = "black", penWidth = "5", penPin = "rect";

var wMargin = 20, hMargin = 60;
var svgW = window.innerWidth - wMargin, svgH = window.innerHeight - hMargin;
var viewX = 0, viewY = 0, viewW = svgW, viewH = svgH;
var startX = 0, startY = 0;

var cursorDiff = 8;
var tLbtn=false, tMbtn=false, tRbtn=false;
var touchDist = 0, touchDistDelta = 0;

var mPath = null;
var curPath = -1;
var svgCache = document.createElementNS("http://www.w3.org/2000/svg", "svg");

var svg = document.getElementById("svgboard");
svg.onmousedown = mousedownHandler;
svg.onmousemove = mousemoveHandler;
svg.onmouseup = mouseupHandler;
svg.onmouseleave = mouseleaveHandler;
svg.oncontextmenu = function(){return false;};
svg.addEventListener("touchstart", touchstartHandler);
svg.addEventListener("touchend", mouseleaveHandler);
svg.addEventListener("touchmove", touchmoveHandler);
svg.addEventListener("mousewheel", mousewheelHandler);

showDebug("AvailW=" + window.innerWidth + ",AvailH=" + window.innerHeight);
setSvgArea(svgW, svgH);
setSvgViewbox(viewX, viewY, viewW, viewH);

var url = "ws://gatherhub.com:3005/";
var clientId = 0 | Math.random() * 100000000;
var wsReady = false;
var keepAliveMsg = null;

var ws = new WebSocket(url);
ws.onopen = function(){
	ws.send(JSON.stringify({id: clientId, action: "connect"}));
	wsReady = true;
};
ws.onmessage = function(msg){
	if (msg.data.match("path")){
		var ctx = JSON.parse(msg.data);
		if (ctx.id != clientId){
			showDebug("id:" + ctx.id + " stroke:" + ctx.stroke + " stroke-width:" + ctx.strokeWidth + " fill:" + ctx.fill);
			showDebug("d:" + ctx.d);
			mPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
			mPath.setAttribute("stroke-width", ctx.strokeWidth);
			mPath.setAttribute("stroke", ctx.stroke);
			mPath.setAttribute("fill", ctx.fill);
			mPath.setAttribute("d", ctx.d);
			svg.appendChild(mPath);
			mPath = null;
		}
	}
	else {
		showDebug(msg.data);
	}
};
ws.onclose = function(){
	showDebug("Connection closed!");
	clearInterval(keepAliveMsg);
	wsReady = false;
};

window.onbeforeunload  = function(){if (wsReady) ws.close();};
window.onresize = svgResize;
keepAliveMsg = setInterval(function(){if (wsReady) ws.send("");}, 30000);

function showDebug(msg){
	if (enableLog) console.log(msg);
}

function setSvgArea(w, h){
	svgW = w;
	svgH = h;
	svg.setAttribute("width", w);
	svg.setAttribute("height", h);
}

function setSvgViewbox(x, y, w, h){
	viewX = x;
	viewY = y;
	viewW = w;
	viewH = h;
	svg.setAttribute("viewBox", x + " " + y + " " + w + " " + h);
	showDebug("ViewX=" + x + ",ViewY=" + y + ",ViewW=" + w + ",ViewH=" + h);
}

function setColor(c){
	penColor = c;
	showDebug("Pen-color=" + penColor);
}

function setWidth(w){
	penWidth = w;
	showDebug("Pen-width=" + penWidth);
}

function setPin(p){
	penPin = p;
	showDebug("Pen-shape=" + penPin);
}

function svgSizeup(t){
	var r = (1 / 32);
	if (t){
		viewX += (viewW * r / 2);
		viewY += (viewH * r / 2);
		viewW /= (1 + r);
		viewH /= (1 + r);
	}
	else{
		viewX -= (viewW * r / 2);
		viewY -= (viewH * r / 2);
		viewW *= (1 + r);
		viewH *= (1 + r);
	}
	setSvgViewbox(viewX, viewY, viewW, viewH);
}

function svgShift(x, y){
	viewX += (startX - x);
	viewY += (startY - y);
	startX = x;
	startY = y;
	setSvgViewbox(viewX, viewY, viewW, viewH);
}

function mousedownHandler(e){
	e.preventDefault();
	if (e.button==0) tLbtn = true;
	if (e.button==1) tMbtn = true;
	if (e.button==2) tRbtn = true;
	startX = e.pageX;
	startY = e.pageY;
	
	if (!tLbtn || tMbtn || tRbtn) return;
	drawStart(startX, startY);
}

function mousemoveHandler(e){
	e.preventDefault();
	if (tMbtn || (tLbtn && tRbtn)) {
		svgShift(e.pageX, e.pageY);
	}
	else {
		drawPath(e.pageX, e.pageY);
	}
}

function mouseupHandler(e) {
	if (e.button==0) tLbtn = false;
	if (e.button==1) tMbtn = false;
	if (e.button==2) tRbtn = false;

	e.preventDefault();
	if (curPath > 0 && svg.childNodes[curPath]) drawEnd();
}

function mouseleaveHandler(e) {
	e.preventDefault();	
	tLbtn = tMbtn = tRbtn = false;
	touchDist = touchDistDelta = 0;
	if (curPath > 0 && svg.childNodes[curPath]) drawEnd();
}

function mousewheelHandler(e){
	e.preventDefault();
	if (e.wheelDelta > 0){
		svgSizeup(true);
	}
	else {
		svgSizeup(false);
	}
}

function touchstartHandler(e){
	e.preventDefault();
	if (e.touches){
		var t = e.touches;
		if (t.length == 2){
			mouseleaveHandler(e);
			touchDist = Math.pow(t[0].pageX - t[1].pageX, 2) + Math.pow(t[0].pageY -t[1].pageY, 2);
		}
		else {
			startX = t[0].pageX;
			startY = t[0].pageY;
			if (curPath < 0 &&  t.length == 1) {
				tLbtn = true;
				drawStart(startX, startY);
			}
		}
	}
}

function touchmoveHandler(e){
	e.preventDefault();
	if (e.touches){
		var t = e.touches;
		if (t.length == 1) {
			tLbtn = true;
			drawPath(t[0].pageX, t[0].pageY);
		}
		else if (t.length == 2){
			var tmpDist = Math.pow(t[0].pageX - t[1].pageX, 2) + Math.pow(t[0].pageY - t[1].pageY, 2);
			touchDistDelta += (tmpDist - touchDist);
			touchDist = tmpDist;
			if (touchDistDelta > 14400){
				svgSizeup(true);
				touchDistDelta = 0;
			}
			if (touchDistDelta < -14400){
				svgSizeup(false);
				touchDistDelta = 0;
			}
		}
		else if (t.length == 3){
			svgShift(t[0].pageX, t[0].pageY);
		}
	}
}

function drawStart(x, y){
	x = x * viewW / svgW + viewX;
	y = y * viewH / svgH + viewY;

	var diffPenW = penWidth / 2;
	var diffCurX = (cursorDiff / penWidth) * (viewW/ svgW);
	var diffCurY = (cursorDiff / penWidth) * (viewH / svgH);
	x -= Math.round(diffPenW + diffCurX);
	y -= Math.round(diffPenW + diffCurY);
	mPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
	mPath.setAttribute("stroke-width", penWidth);
	mPath.setAttribute("stroke-linecap", penPin);
	mPath.setAttribute("stroke", penColor);
	mPath.setAttribute("fill", "none");
	mPath.setAttribute("d", "M" + x + "," + y + "L" + x + "," + y);
	svg.appendChild(mPath);
	curPath = svg.childNodes.length - 1;
}

function drawPath(x, y){
	if (curPath > 0) {
		x = x * viewW / svgW + viewX;
		y = y * viewH / svgH + viewY;
		var diffPenW = penWidth / 2;
		var diffCurX = (cursorDiff / penWidth) * (viewW / svgW);
		var diffCurY = (cursorDiff / penWidth) * (viewH / svgH);
		x -= Math.round(diffPenW + diffCurX);
		y -= Math.round(diffPenW + diffCurY);
		var node = svg.childNodes[curPath];
		node.setAttribute("d", node.getAttribute("d") + "L" + x + "," + y);
	}
}

function drawEnd(){
	if (wsReady) {
		var dVal = svg.childNodes[curPath].getAttribute("d");
		var strokeVal = svg.childNodes[curPath].getAttribute("stroke");
		var strokeWdVal = svg.childNodes[curPath].getAttribute("stroke-width");
		var fillVal = svg.childNodes[curPath].getAttribute("fill");
		
		ws.send(JSON.stringify({id: clientId, action: "path", 
			stroke: strokeVal,
			strokeWidth: strokeWdVal,
			fill: fillVal,
			d: dVal}));
	}
	curPath = -1;
	mPath = null;
}

function undo(){
	var node = svg.childNodes[svg.childNodes.length - 1];
	if (node.tagName == "path") {
		svgCache.appendChild(node);
		return true;
	}
	return false;
}

function redo(){
	var nodes = svgCache.childNodes;
	if (nodes.length > 0) {
		var node = nodes[nodes.length - 1];
		if (node.tagName == "path") svg.appendChild(node);
	}
}

function reset(){
	var nodes = svgCache.childNodes;
	while (undo()) {};
	while (nodes.length > 0) svgCache.removeChild(nodes[nodes.length - 1]);
	svgResize();
}

function svgResize(){
	setSvgArea(window.innerWidth - wMargin, window.innerHeight - hMargin);
	setSvgViewbox(0, 0, svgW, svgH);
}
</script>
</html>