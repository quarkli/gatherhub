<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>SVG Lab1</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
		<div id="whiteboard">
			<svg id="svgboard" width="640" height="480" viewBox="0 0 640 480">
				<rect width="640" height="480" stroke-width="5" stroke="#000000" fill="none"/>
			</svg>
		</div>
		<div id="toolbar">
			<button onclick="setColor('black')">K</button>
			<button onclick="setColor('red')">R</button>
			<button onclick="setColor('green')">G</button>
			<button onclick="setColor('blue')">B</button>
			<button onclick="setColor('white')">W</button>
			<button onclick="setWidth('1')">1</button>
			<button onclick="setWidth('5')">5</button>
			<button onclick="setWidth('9')">9</button>
			<button onclick="setWidth('18')">18</button>
			<button onclick="setPin('rect')">方</button>
			<button onclick="setPin('round')">圆</button>
			<button onclick="undo()">Undo</button>
			<button onclick="redo()">Redo</button>
			<button onclick="undoAll()">Clear</button>
		</div>
    </body>
<script>
console.log("w="+window.screen.width+",h="+window.screen.height);
console.log("x="+window.innerWidth+",y="+window.innerHeight)
var svg = document.getElementById("svgboard");
var svgCache = document.createElementNS("http://www.w3.org/2000/svg","svg");
var mPath = null;
var curPath = -1;
var penColor = "black";
var penWidth = "5";
var penPin = "rect";
var clientId = 0 | Math.random()*100000000;
var keepAliveMsg = null;
var wsReady = false;
var tLbtn=false, tMbtn=false, tRbtn=false;
var viewX=0, viewY=0, viewW=640, viewH=480;
var startX=0, startY=0;

svg.onmousedown = mousedownHandler;
svg.onmousemove = mousemoveHandler;
svg.onmouseup = mouseupHandler;
svg.onmouseleave = mouseleaveHandler;
svg.oncontextmenu = function(){return false;};
svg.addEventListener("touchstart",function(e){tLbtn=true;drawStart(e);});
svg.addEventListener("touchend",function(e){tLbtn=false;drawEnd(e);});
svg.addEventListener("touchmove",drawPath);

var url = "ws://gatherhub.com:3005/";
var ws = new WebSocket(url);
ws.onopen = function(){
	ws.send(JSON.stringify({id: clientId, action: "connect"}));
	wsReady = true;
};
ws.onmessage = function(msg){
	if (msg.data.match("path")){
		var ctx = JSON.parse(msg.data);
		if (ctx.id != clientId){
			console.log("id:"+ctx.id+" stroke:"+ctx.stroke+" stroke-width:"+ctx.strokeWidth+" fill:"+ctx.fill);
			console.log("d:"+ctx.d);
			mPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
			mPath.setAttribute("stroke-width", ctx.strokeWidth);
			mPath.setAttribute("stroke", ctx.stroke);
			mPath.setAttribute("fill", ctx.fill);
			mPath.setAttribute("d", ctx.d);
			svg.appendChild(mPath);
			mPath = null;
		}
	}
	else {
		console.log(msg.data);
	}
};
ws.onclose = function(){
	console.log("Connection closed!");
	clearInterval(keepAliveMsg);
	wsReady = false;
};
window.onbeforeunload  = function(){if (wsReady) ws.close();};
keepAliveMsg = setInterval(function(){ ws.send(""); }, 30000);

function setColor(c){
	penColor = c;
}

function setWidth(w){
	penWidth = w;
}

function setPin(p){
	penPin = p;
}

function mousedownHandler(e){
	if (e.button==0) tLbtn = true;
	if (e.button==1) tMbtn = true;
	if (e.button==2) tRbtn = true;
	startX = e.pageX;
	startY = e.pageY;
	e.preventDefault();
	
	if (!tLbtn || tMbtn || tRbtn) return;
	drawStart(e);
}

function mousemoveHandler(e){
	if (tMbtn || (tLbtn && tRbtn)) {
		viewX += (startX - e.pageX);
		viewY += (startY - e.pageY);
		svg.setAttribute("viewBox", viewX+" "+viewY+" "+viewW+" "+viewH);
		startX = e.pageX;
		startY = e.pageY;
	}
	else {
		drawPath(e);
	}
}

function mouseupHandler(e) {
	if (e.button==0) tLbtn = false;
	if (e.button==1) tMbtn = false;
	if (e.button==2) tRbtn = false;

	if (curPath > 0 && svg.childNodes[curPath]) drawEnd(e);
	e.preventDefault();
}

function mouseleaveHandler(e) {
	tLbtn = tMbtn = tRbtn = false;
	if (curPath > 0 && svg.childNodes[curPath]) drawEnd(e);
	e.preventDefault();	
}

function drawStart(e){
	var x,y;
	if (e.changedTouches) {
		x = e.changedTouches[0].pageX + viewX;
		y = e.changedTouches[0].pageY + viewY;
		tLbtn = true;
	}
	else {
		x = e.pageX + viewX;
		y = e.pageY + viewY;
	}
	
	mPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
	mPath.setAttribute("stroke-width", penWidth);
	mPath.setAttribute("stroke-linecap", penPin);
	mPath.setAttribute("stroke", penColor);
	mPath.setAttribute("fill", "none");
	mPath.setAttribute("d", "M"+(x-penWidth/2)+","+(y-penWidth/2)+"L"+(x-penWidth/2)+","+(y-penWidth/2));
	svg.appendChild(mPath);
	curPath = svg.childNodes.length -1;
}

function drawPath(e){
	if (curPath > 0) {
		var x,y;
		if (e.changedTouches) {
			x = e.changedTouches[0].pageX + viewX;
			y = e.changedTouches[0].pageY + viewY;
		}
		else {
			x = e.pageX + viewX;
			y = e.pageY + viewY;
		}
		svg.childNodes[curPath].setAttribute("d",svg.childNodes[curPath].getAttribute("d")+"L"+(x-penWidth/2)+","+(y-penWidth/2));
		e.preventDefault();
	}
}

function drawEnd(e){
	if (wsReady) {
		var dVal = svg.childNodes[curPath].getAttribute("d");
		var strokeVal = svg.childNodes[curPath].getAttribute("stroke");
		var strokeWdVal = svg.childNodes[curPath].getAttribute("stroke-width");
		var fillVal = svg.childNodes[curPath].getAttribute("fill");
		
		ws.send(JSON.stringify({id: clientId, action: "path", 
			stroke: strokeVal,
			strokeWidth: strokeWdVal,
			fill: fillVal,
			d: dVal}));
	}
	curPath = -1;
	mPath = null;
}

function undo(){
	var node = svg.childNodes[svg.childNodes.length-1];
	if (node.tagName == "path") {
		svgCache.appendChild(node);
		return true;
	}
	return false;
}

function redo(){
	var nodes = svgCache.childNodes;
	if (nodes.length > 0) {
		var node = nodes[nodes.length-1];
		if (node.tagName == "path") svg.appendChild(node);
	}
}

function undoAll(){
	var nodes = svgCache.childNodes;
	while (undo()) {};
	while (nodes.length > 0) svgCache.removeChild(nodes[bodes.length-1]);
}
</script>
</html>